<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Orçamento Pessoal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Linhas adicionadas para PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .view-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto max-w-7xl p-4 sm:p-6">

        <!-- Cabeçalho -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Meu Orçamento</h1>
            <p class="text-gray-500 mt-1">Controle suas finanças de forma simples e eficaz.</p>
        </header>

        <!-- Seção de Resumo -->
        <section id="summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-sm font-medium text-gray-500">Receitas</h2>
                <p id="total-revenue" class="text-2xl font-semibold text-green-600 mt-1">R$ 0,00</p>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-sm font-medium text-gray-500">Despesas</h2>
                <p id="total-expenses" class="text-2xl font-semibold text-red-600 mt-1">R$ 0,00</p>
            </div>
             <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-sm font-medium text-gray-500">Saldo Disponível</h2>
                <p id="balance" class="text-2xl font-semibold text-gray-800 mt-1">R$ 0,00</p>
            </div>
             <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-sm font-medium text-gray-500">Importado (Pendente)</h2>
                <p id="total-imported" class="text-2xl font-semibold text-gray-600 mt-1">0</p>
            </div>
            <div id="debt-summary-card" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow">
                <h2 class="text-sm font-medium text-gray-500">Dívidas (Pagamentos)</h2>
                <p id="total-debts" class="text-2xl font-semibold text-orange-600 mt-1">R$ 0,00</p>
                 <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                        <div id="debt-progress" class="bg-orange-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Falta: <strong id="debt-remaining-display" class="text-gray-700">R$ 0,00</strong></span>
                        <span>Total: <strong id="debt-goal-display" class="text-gray-700">R$ 0,00</strong></span>
                    </div>
                </div>
            </div>
            <div id="credit-card-summary-card" class="bg-white p-5 rounded-xl shadow-md border border-gray-200 cursor-pointer hover:shadow-lg transition-shadow">
                <h2 class="text-sm font-medium text-gray-500">Cartões de Crédito (Fatura)</h2>
                <p id="total-credit-card" class="text-2xl font-semibold text-cyan-600 mt-1">R$ 0,00</p>
                 <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                        <div id="credit-card-progress" class="bg-cyan-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Limite Total: <strong id="credit-card-limit-display" class="text-gray-700">R$ 0,00</strong></span>
                    </div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-sm font-medium text-gray-500">Investimentos</h2>
                    <button id="edit-investment-goal-btn" class="text-gray-400 hover:text-purple-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg></button>
                </div>
                <p id="total-investments" class="text-2xl font-semibold text-purple-600 mt-1">R$ 0,00</p>
                <div class="mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-1">
                        <div id="investment-progress" class="bg-purple-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Meta: <strong id="investment-goal-display" class="text-gray-700">R$ 0,00</strong></span>
                    </div>
                </div>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200">
                <h2 class="text-sm font-medium text-gray-500">Reserva de Emergência</h2>
                <p id="total-emergency" class="text-2xl font-semibold text-yellow-600 mt-1">R$ 0,00</p>
            </div>
        </section>

        <!-- Botões de Navegação de Visão -->
        <div class="flex justify-center mb-6">
            <div class="bg-gray-200 p-1 rounded-lg">
                <button id="transactions-view-btn" class="view-btn px-4 py-2 text-sm font-semibold rounded-md active">Transações</button>
                <button id="dashboard-view-btn" class="view-btn px-4 py-2 text-sm font-semibold rounded-md">Dashboard</button>
            </div>
        </div>

        <!-- Seção de Transações (Visão Padrão) -->
        <div id="transactions-view">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <main class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-xl font-bold">Transações</h2>
                        <div class="flex gap-2">
                            <button id="import-btn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-gray-700">Importar</button>
                            <button id="add-transaction-btn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700">+ Nova</button>
                        </div>
                    </div>
                    <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        <div id="no-transactions-message" class="text-center text-gray-500 py-10"><p>Nenhuma transação registrada.</p></div>
                    </div>
                </main>
                
                <aside class="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                    <h2 class="text-xl font-bold mb-2">Importadas para Categorizar</h2>
                    <div class="grid grid-cols-3 gap-2 text-center mb-4 border-b pb-4">
                        <div>
                            <p class="text-xs text-gray-500">Entradas</p>
                            <p id="imported-revenue" class="font-semibold text-green-600 text-sm">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Saídas</p>
                            <p id="imported-expenses" class="font-semibold text-red-600 text-sm">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">Saldo</p>
                            <p id="imported-balance" class="font-semibold text-gray-700 text-sm">R$ 0,00</p>
                        </div>
                    </div>
                    <div id="imported-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        <div id="no-imported-message" class="text-center text-gray-500 py-10"><p>Nenhuma transação importada pendente.</p></div>
                    </div>
                </aside>
            </div>
        </div>

        <!-- Seção do Dashboard (Visão Oculta) -->
        <div id="dashboard-view" class="hidden">
            <div class="text-center mb-6">
                 <button id="analyze-btn" class="bg-purple-600 text-white font-semibold px-6 py-3 rounded-lg shadow-sm hover:bg-purple-700 transition-transform transform hover:scale-105">
                    ✨ Analisar Minhas Finanças
                </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200"><h3 class="text-lg font-bold mb-4 text-center">Saídas por Categoria</h3><div class="h-80 flex justify-center items-center"><canvas id="outgoings-chart"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200"><h3 class="text-lg font-bold mb-4 text-center">Receitas vs. Saídas</h3><div class="h-80 flex justify-center items-center"><canvas id="flow-chart"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 lg:col-span-2"><h3 class="text-lg font-bold mb-4 text-center">Evolução do Saldo</h3><div class="h-80"><canvas id="balance-chart"></canvas></div></div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="transaction-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="investment-goal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="debt-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="debt-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="credit-card-details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="credit-card-form-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="categorize-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none"><!-- ... --></div>
    <div id="analysis-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 modal-content transform scale-95">
             <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">✨ Análise Financeira Inteligente</h2><button id="close-analysis-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div>
             <div id="analysis-content" class="text-gray-700 max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>
    
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // O HTML dos modais e do formulário de transação são omitidos para brevidade, mas estão no script
        document.getElementById('transaction-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Nova Transação</h2><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><form id="transaction-form"><div class="mb-4"><label for="description" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label><input type="text" id="description" placeholder="Ex: Salário, Aluguel" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="amount" class="block text-sm font-medium text-gray-700 mb-1">Valor</label><input type="number" id="amount" step="0.01" placeholder="0,00" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div id="debt-selector-container" class="mb-4 hidden"><label for="debt-selector" class="block text-sm font-medium text-gray-700 mb-1">Para qual Dívida?</label><select id="debt-selector" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></select></div><div id="credit-card-selector-container" class="mb-4 hidden"><label for="credit-card-selector" class="block text-sm font-medium text-gray-700 mb-1">Qual Cartão de Crédito?</label><select id="credit-card-selector" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></select></div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Tipo</label><div class="grid grid-cols-2 gap-3"><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-green-50 has-[:checked]:border-green-500"><input type="radio" name="type" value="revenue" class="h-4 w-4 text-green-600" checked><span class="ml-3 text-sm">Receita</span></label><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-red-50 has-[:checked]:border-red-500"><input type="radio" name="type" value="expense" class="h-4 w-4 text-red-600"><span class="ml-3 text-sm">Despesa</span></label><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-orange-50 has-[:checked]:border-orange-500"><input type="radio" name="type" value="debt" class="h-4 w-4 text-orange-600"><span class="ml-3 text-sm">Dívida</span></label><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-500"><input type="radio" name="type" value="investment" class="h-4 w-4 text-purple-600"><span class="ml-3 text-sm">Investimento</span></label><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-cyan-50 has-[:checked]:border-cyan-500"><input type="radio" name="type" value="creditCard" class="h-4 w-4 text-cyan-600"><span class="ml-3 text-sm">Cartão de Crédito</span></label><label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500"><input type="radio" name="type" value="emergency" class="h-4 w-4 text-yellow-600"><span class="ml-3 text-sm">Reserva</span></label></div></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Salvar</button></form></div>`;
        document.getElementById('import-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Importar Extrato CSV</h2><button id="close-import-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><div class="text-sm text-gray-600 bg-gray-100 p-3 rounded-lg mb-4"><p class="font-semibold">O CSV deve ter 3 colunas:</p><ul class="list-disc list-inside mt-1"><li>Data (dd/mm/aaaa)</li><li>Descrição</li><li>Valor</li></ul></div><form id="import-form"><div class="mb-4"><label for="csv-file" class="block text-sm font-medium text-gray-700 mb-1">Selecione o arquivo</label><input type="file" id="csv-file" accept=".csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required></div><button type="submit" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-700">Importar</button></form></div>`;
        document.getElementById('investment-goal-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Meta de Investimento</h2><button id="close-investment-goal-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><form id="investment-goal-form"><div class="mb-4"><label for="investment-goal-amount" class="block text-sm font-medium text-gray-700 mb-1">Valor da Meta</label><input type="number" id="investment-goal-amount" step="0.01" placeholder="0,00" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Salvar</button></form></div>`;
        document.getElementById('debt-details-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Detalhes das Dívidas</h2><button id="add-debt-btn" class="bg-orange-500 text-white font-semibold px-3 py-1 rounded-lg text-sm hover:bg-orange-600">+ Nova Dívida</button></div><div id="debt-details-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div><button id="close-debt-details-modal-btn" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button></div>`;
        document.getElementById('debt-form-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 id="debt-form-title" class="text-xl font-bold">Nova Dívida</h2><button id="close-debt-form-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><form id="debt-form"><input type="hidden" id="debt-id"><div class="mb-4"><label for="debt-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Dívida</label><input type="text" id="debt-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="debt-total" class="block text-sm font-medium text-gray-700 mb-1">Valor Total</label><input type="number" id="debt-total" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700">Salvar Dívida</button></form></div>`;
        document.getElementById('credit-card-details-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Detalhes dos Cartões de Crédito</h2><button id="add-credit-card-btn" class="bg-cyan-500 text-white font-semibold px-3 py-1 rounded-lg text-sm hover:bg-cyan-600">+ Novo Cartão</button></div><div id="credit-card-details-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div><button id="close-credit-card-details-modal-btn" class="mt-6 w-full bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Fechar</button></div>`;
        document.getElementById('credit-card-form-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 id="credit-card-form-title" class="text-xl font-bold">Novo Cartão</h2><button id="close-credit-card-form-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><form id="credit-card-form"><input type="hidden" id="credit-card-id"><div class="mb-4"><label for="credit-card-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cartão</label><input type="text" id="credit-card-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><div class="mb-4"><label for="credit-card-limit" class="block text-sm font-medium text-gray-700 mb-1">Limite Total</label><input type="number" id="credit-card-limit" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required></div><button type="submit" class="w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700">Salvar Cartão</button></form></div>`;
        document.getElementById('categorize-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 modal-content transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">Categorizar Transação</h2><button id="close-categorize-modal-btn" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button></div><div class="mb-4 p-3 bg-gray-50 rounded-lg"><p id="categorize-description" class="font-semibold"></p><p id="categorize-amount" class="text-gray-600"></p></div><div class="grid grid-cols-2 gap-3"><button data-type="revenue" class="categorize-btn w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">Receita</button><button data-type="expense" class="categorize-btn w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700">Despesa</button><button data-type="debt" class="categorize-btn w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700">Dívida</button><button data-type="investment" class="categorize-btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Investimento</button><button data-type="creditCard" class="categorize-btn w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-700">Cartão de Crédito</button><button data-type="emergency" class="categorize-btn w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600">Reserva</button></div></div>`;
        document.getElementById('confirm-modal').innerHTML = `<div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 modal-content transform scale-95 text-center"><h2 class="text-xl font-bold mb-4">Confirmar Exclusão</h2><p id="confirm-modal-text" class="text-gray-600 mb-6"></p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-semibold">Cancelar</button><button id="confirm-delete-btn" class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-semibold">Excluir</button></div></div>`;
        
        document.addEventListener('DOMContentLoaded', async () => {
             // --- Configuração do Firebase ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'budget-app-default';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let userId = null;
            let userDocRef = null;
            let unsubscribe = null; // Para o listener do onSnapshot

            // Seletores de Elementos do DOM
            const transactionList = document.getElementById('transaction-list');
            const importedList = document.getElementById('imported-list');
            const totalRevenueEl = document.getElementById('total-revenue');
            const totalExpensesEl = document.getElementById('total-expenses');
            const balanceEl = document.getElementById('balance');
            const totalInvestmentsEl = document.getElementById('total-investments');
            const totalEmergencyEl = document.getElementById('total-emergency');
            const totalDebtsEl = document.getElementById('total-debts');
            const totalCreditCardEl = document.getElementById('total-credit-card');
            const totalImportedEl = document.getElementById('total-imported');
            const noTransactionsMessage = document.getElementById('no-transactions-message');
            const noImportedMessage = document.getElementById('no-imported-message');
            const investmentProgressEl = document.getElementById('investment-progress');
            const investmentGoalDisplayEl = document.getElementById('investment-goal-display');
            const debtProgressEl = document.getElementById('debt-progress');
            const debtGoalDisplayEl = document.getElementById('debt-goal-display');
            const debtRemainingDisplayEl = document.getElementById('debt-remaining-display');
            const creditCardProgressEl = document.getElementById('credit-card-progress');
            const creditCardLimitDisplayEl = document.getElementById('credit-card-limit-display');
            const importedRevenueEl = document.getElementById('imported-revenue');
            const importedExpensesEl = document.getElementById('imported-expenses');
            const importedBalanceEl = document.getElementById('imported-balance');
            const transactionsView = document.getElementById('transactions-view');
            const dashboardView = document.getElementById('dashboard-view');
            const transactionsViewBtn = document.getElementById('transactions-view-btn');
            const dashboardViewBtn = document.getElementById('dashboard-view-btn');
            const debtSelectorContainer = document.getElementById('debt-selector-container');
            const debtSelector = document.getElementById('debt-selector');
            const creditCardSelectorContainer = document.getElementById('credit-card-selector-container');
            const creditCardSelector = document.getElementById('credit-card-selector');
            const debtDetailsList = document.getElementById('debt-details-list');
            const creditCardDetailsList = document.getElementById('credit-card-details-list');
            
            // Modais
            const modals = {
                transaction: document.getElementById('transaction-modal'),
                import: document.getElementById('import-modal'),
                investmentGoal: document.getElementById('investment-goal-modal'),
                debtDetails: document.getElementById('debt-details-modal'),
                debtForm: document.getElementById('debt-form-modal'),
                creditCardDetails: document.getElementById('credit-card-details-modal'),
                creditCardForm: document.getElementById('credit-card-form-modal'),
                categorize: document.getElementById('categorize-modal'),
                confirm: document.getElementById('confirm-modal'),
                analysis: document.getElementById('analysis-modal')
            };

            // Estado da Aplicação
            let transactions = [];
            let investmentGoal = 0;
            let debts = [];
            let creditCards = [];
            let currentTransactionToCategorizeId = null;
            let itemToDelete = { id: null, type: null };
            let charts = {};

            const formatCurrency = (amount) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
            
            const calculateTotal = (type) => transactions.filter(t => t.type === type).reduce((acc, t) => acc + t.amount, 0);

            const renderCategorizedTransactions = () => {
                const categorized = transactions.filter(t => t.type !== 'imported');
                transactionList.innerHTML = ''; 
                noTransactionsMessage.style.display = categorized.length === 0 ? 'block' : 'none';
                
                categorized.sort((a, b) => b.id - a.id).forEach(transaction => {
                    const typeInfo = {
                        revenue: { sign: '+', borderColor: 'border-green-500', textColor: 'text-green-600' },
                        expense: { sign: '-', borderColor: 'border-red-500', textColor: 'text-red-600' },
                        debt: { sign: '-', borderColor: 'border-orange-500', textColor: 'text-orange-600' },
                        creditCard: { sign: '-', borderColor: 'border-cyan-500', textColor: 'text-cyan-600' },
                        investment: { sign: '-', borderColor: 'border-purple-500', textColor: 'text-purple-600' },
                        emergency: { sign: '-', borderColor: 'border-yellow-500', textColor: 'text-yellow-600' }
                    };
                    const info = typeInfo[transaction.type];
                    const transactionEl = document.createElement('div');
                    transactionEl.className = `flex justify-between items-center p-3 bg-gray-50 rounded-lg border-l-4 ${info.borderColor}`;
                    transactionEl.innerHTML = `<div class="flex-1"><p class="font-semibold">${transaction.description}</p><p class="text-sm text-gray-500">${new Date(transaction.id).toLocaleDateString('pt-BR')}</p></div><div class="text-right"><p class="font-semibold ${info.textColor}">${info.sign} ${formatCurrency(transaction.amount)}</p></div><button class="ml-4 text-gray-400 hover:text-red-600" onclick="deleteTransaction(${transaction.id})"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>`;
                    transactionList.appendChild(transactionEl);
                });
            };

            const renderImportedTransactions = () => {
                const imported = transactions.filter(t => t.type === 'imported');
                importedList.innerHTML = '';
                noImportedMessage.style.display = imported.length === 0 ? 'block' : 'none';

                imported.sort((a, b) => b.id - a.id).forEach(t => {
                    const isNegative = t.amount < 0;
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border-l-4 border-gray-400 cursor-pointer hover:bg-gray-100';
                    el.innerHTML = `<div class="flex-1"><p class="font-semibold">${t.description}</p></div><div class="flex items-center gap-2"><p class="font-semibold ${isNegative ? 'text-red-600' : 'text-green-600'}">${formatCurrency(Math.abs(t.amount))}</p><button onclick="suggestCategory(${t.id}, this)" class="text-purple-500 hover:text-purple-700">✨</button></div>`;
                    el.onclick = (e) => { if (e.target.tagName !== 'BUTTON') openCategorizeModal(t.id); };
                    importedList.appendChild(el);
                });
            };

            const updateSummary = () => {
                const totalRevenue = calculateTotal('revenue');
                const totalExpenses = calculateTotal('expense');
                const totalInvestments = calculateTotal('investment');
                const totalEmergency = calculateTotal('emergency');
                const totalDebtsPaid = calculateTotal('debt');
                const totalCreditCard = calculateTotal('creditCard');
                const balance = totalRevenue - (totalExpenses + totalInvestments + totalEmergency + totalDebtsPaid);

                totalRevenueEl.textContent = formatCurrency(totalRevenue);
                totalExpensesEl.textContent = formatCurrency(totalExpenses);
                totalInvestmentsEl.textContent = formatCurrency(totalInvestments);
                totalEmergencyEl.textContent = formatCurrency(totalEmergency);
                totalDebtsEl.textContent = formatCurrency(totalDebtsPaid);
                totalCreditCardEl.textContent = formatCurrency(totalCreditCard);
                balanceEl.textContent = formatCurrency(balance);
                balanceEl.className = 'text-2xl font-semibold mt-1 ' + (balance > 0 ? 'text-green-600' : balance < 0 ? 'text-red-600' : 'text-gray-800');

                investmentGoalDisplayEl.textContent = formatCurrency(investmentGoal);
                investmentProgressEl.style.width = `${investmentGoal > 0 ? Math.min((totalInvestments / investmentGoal) * 100, 100) : 0}%`;

                const totalDebtAmount = debts.reduce((acc, debt) => acc + debt.total, 0);
                const remainingDebt = Math.max(0, totalDebtAmount - totalDebtsPaid);
                debtGoalDisplayEl.textContent = formatCurrency(totalDebtAmount);
                debtRemainingDisplayEl.textContent = formatCurrency(remainingDebt);
                debtProgressEl.style.width = `${totalDebtAmount > 0 ? Math.min((totalDebtsPaid / totalDebtAmount) * 100, 100) : 0}%`;

                const totalCreditCardLimit = creditCards.reduce((acc, card) => acc + card.limit, 0);
                creditCardLimitDisplayEl.textContent = formatCurrency(totalCreditCardLimit);
                creditCardProgressEl.style.width = `${totalCreditCardLimit > 0 ? Math.min((totalCreditCard / totalCreditCardLimit) * 100, 100) : 0}%`;

                const importedTransactions = transactions.filter(t => t.type === 'imported');
                totalImportedEl.textContent = importedTransactions.length;
                const importedRevenue = importedTransactions.filter(t => t.amount > 0).reduce((acc, t) => acc + t.amount, 0);
                const importedExpenses = importedTransactions.filter(t => t.amount < 0).reduce((acc, t) => acc + Math.abs(t.amount), 0);
                const importedBalance = importedRevenue - importedExpenses;
                importedRevenueEl.textContent = formatCurrency(importedRevenue);
                importedExpensesEl.textContent = formatCurrency(importedExpenses);
                importedBalanceEl.textContent = formatCurrency(importedBalance);
                importedBalanceEl.className = 'font-semibold text-sm ' + (importedBalance >= 0 ? 'text-green-600' : 'text-red-600');
            };

            const updateDashboard = () => {
                const categorized = transactions.filter(t => t.type !== 'imported');
                const typeMap = { expense: 'Despesas', debt: 'Dívidas', creditCard: 'Cartão de Crédito', investment: 'Investimentos', emergency: 'Reserva' };
                const colorMap = { expense: '#ef4444', debt: '#ea580c', creditCard: '#0891b2', investment: '#9333ea', emergency: '#ca8a04' };
                const outgoingsData = Object.keys(typeMap).reduce((acc, type) => {
                    const total = categorized.filter(t => t.type === type).reduce((sum, t) => sum + t.amount, 0);
                    if (total > 0) acc[typeMap[type]] = (acc[typeMap[type]] || 0) + total;
                    return acc;
                }, {});
                if (charts.outgoings) charts.outgoings.destroy();
                charts.outgoings = new Chart(document.getElementById('outgoings-chart'), { type: 'doughnut', data: { labels: Object.keys(outgoingsData), datasets: [{ data: Object.values(outgoingsData), backgroundColor: Object.keys(outgoingsData).map(label => colorMap[Object.keys(typeMap).find(key => typeMap[key] === label)]) }] }, options: { responsive: true, maintainAspectRatio: false } });
                const totalRevenue = calculateTotal('revenue');
                const totalOutgoings = calculateTotal('expense') + calculateTotal('debt') + calculateTotal('investment') + calculateTotal('emergency') + calculateTotal('creditCard');
                if (charts.flow) charts.flow.destroy();
                charts.flow = new Chart(document.getElementById('flow-chart'), { type: 'bar', data: { labels: ['Fluxo de Caixa'], datasets: [{ label: 'Receitas', data: [totalRevenue], backgroundColor: '#22c55e' }, { label: 'Saídas', data: [totalOutgoings], backgroundColor: '#ef4444' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
                const sorted = categorized.sort((a, b) => a.id - b.id);
                let runningBalance = 0;
                const balanceData = sorted.map(t => { runningBalance += (t.type === 'revenue' ? t.amount : -t.amount); return { x: new Date(t.id).toLocaleDateString('pt-BR'), y: runningBalance }; });
                if (charts.balance) charts.balance.destroy();
                charts.balance = new Chart(document.getElementById('balance-chart'), { type: 'line', data: { labels: balanceData.map(d => d.x), datasets: [{ label: 'Saldo', data: balanceData.map(d => d.y), borderColor: '#3b82f6', tension: 0.1, fill: false }] }, options: { responsive: true, maintainAspectRatio: false } });
            };

            const addTransaction = async (e) => {
                e.preventDefault();
                const description = document.getElementById('description').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const type = document.querySelector('input[name="type"]:checked').value;
                if (description.trim() === '' || isNaN(amount) || amount <= 0) return;
                const newTransaction = { id: Date.now(), description, amount, type };
                if (type === 'debt') newTransaction.debtId = parseInt(debtSelector.value);
                if (type === 'creditCard') newTransaction.creditCardId = parseInt(creditCardSelector.value);
                
                const newTransactions = [...transactions, newTransaction];
                await updateDoc(userDocRef, { transactions: newTransactions });

                closeModal(modals.transaction);
                document.getElementById('transaction-form').reset();
            };
            
            window.deleteTransaction = async (id) => {
                const newTransactions = transactions.filter(t => t.id !== id);
                await updateDoc(userDocRef, { transactions: newTransactions });
            };

            const setInvestmentGoal = async (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('investment-goal-amount').value);
                if (isNaN(amount) || amount < 0) return;
                await updateDoc(userDocRef, { "settings.investmentGoal": amount });
                closeModal(modals.investmentGoal);
            };

            const handleImport = async (e) => {
                e.preventDefault();
                const file = document.getElementById('csv-file').files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const newImported = [];
                    const rows = event.target.result.split('\n').slice(1);
                    rows.forEach((row, index) => {
                        try {
                            const [dateStr, description, amountStr] = row.split(',');
                            if (!dateStr || !description || !amountStr) return;
                            const amount = parseFloat(amountStr.replace(/[R$\s\.]/g, '').replace(',', '.'));
                            if (isNaN(amount)) return;
                            const dateParts = dateStr.split('/');
                            const date = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);
                            newImported.push({ id: date.getTime() + index, description: description.trim(), amount, type: 'imported' });
                        } catch (error) { console.error(`Erro na linha ${index + 1}: ${row}`, error); }
                    });
                    
                    const newTransactions = [...transactions, ...newImported];
                    await updateDoc(userDocRef, { transactions: newTransactions });

                    closeModal(modals.import);
                    document.getElementById('import-form').reset();
                };
                reader.readAsText(file);
            };

            window.openCategorizeModal = (id) => {
                currentTransactionToCategorizeId = id;
                const transaction = transactions.find(t => t.id === id);
                if (!transaction) return;
                document.getElementById('categorize-description').textContent = transaction.description;
                document.getElementById('categorize-amount').textContent = formatCurrency(Math.abs(transaction.amount));
                openModal(modals.categorize);
            };

            const categorizeTransaction = async (newType) => {
                const index = transactions.findIndex(t => t.id === currentTransactionToCategorizeId);
                if (index === -1) return;
                
                const newTransactions = [...transactions];
                newTransactions[index].type = newType;
                newTransactions[index].amount = Math.abs(newTransactions[index].amount);
                
                await updateDoc(userDocRef, { transactions: newTransactions });
                closeModal(modals.categorize);
            };
            
            const geminiApiCall = async (prompt, retries = 3, delay = 1000) => {
                const apiKey = ""; // Deixe em branco, será fornecido pelo ambiente
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };

                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            return result.candidates[0].content.parts[0].text;
                        } else {
                            throw new Error("Resposta da API inválida ou vazia.");
                        }
                    } catch (error) {
                        console.error(`Tentativa ${i + 1} falhou:`, error);
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                        } else {
                            return null; // Retorna nulo após todas as tentativas falharem
                        }
                    }
                }
            };

            window.suggestCategory = async (id, buttonElement) => {
                const originalContent = buttonElement.innerHTML;
                buttonElement.innerHTML = '<div class="spinner"></div>';
                buttonElement.disabled = true;

                const transaction = transactions.find(t => t.id === id);
                if (!transaction) return;

                const prompt = `Dada a descrição da transação "${transaction.description}", classifique-a em uma das seguintes categorias: revenue, expense, debt, investment, creditCard, emergency. Responda apenas com o nome da categoria.`;
                const suggestedCategory = await geminiApiCall(prompt);
                
                if (suggestedCategory && ['revenue', 'expense', 'debt', 'investment', 'creditCard', 'emergency'].includes(suggestedCategory.trim())) {
                    currentTransactionToCategorizeId = id;
                    await categorizeTransaction(suggestedCategory.trim());
                } else {
                    alert('Não foi possível sugerir uma categoria. Por favor, categorize manualmente.');
                    buttonElement.innerHTML = originalContent;
                    buttonElement.disabled = false;
                }
            };
            
            const getFinancialAnalysis = async () => {
                const analysisContent = document.getElementById('analysis-content');
                analysisContent.innerHTML = '<div class="flex justify-center items-center h-40"><div class="spinner" style="width: 40px; height: 40px; border-width: 4px;"></div></div>';
                openModal(modals.analysis);

                const totalRevenue = calculateTotal('revenue');
                const totalExpenses = calculateTotal('expense');
                const totalDebtsPaid = calculateTotal('debt');
                const totalCreditCard = calculateTotal('creditCard');
                const totalInvestments = calculateTotal('investment');
                const totalEmergency = calculateTotal('emergency');
                const totalDebtAmount = debts.reduce((acc, debt) => acc + debt.total, 0);

                const prompt = `
                    Você é um consultor financeiro amigável e prestativo. Analise os seguintes dados financeiros de um usuário no Brasil e forneça um resumo da sua saúde financeira, seguido por 3 dicas práticas e acionáveis para melhorar. Seja encorajador e evite jargões complexos. Formate a resposta em HTML simples com parágrafos <p>, títulos <strong> e uma lista não ordenada <ul> para as dicas.

                    Dados Financeiros (mensal):
                    - Renda Total: ${formatCurrency(totalRevenue)}
                    - Despesas Gerais: ${formatCurrency(totalExpenses)}
                    - Pagamentos de Dívidas (Empréstimos): ${formatCurrency(totalDebtsPaid)}
                    - Gastos no Cartão de Crédito: ${formatCurrency(totalCreditCard)}
                    - Investimentos: ${formatCurrency(totalInvestments)}
                    - Aportes na Reserva de Emergência: ${formatCurrency(totalEmergency)}
                    - Dívida Total (Empréstimos): ${formatCurrency(totalDebtAmount)}

                    Analise a proporção de gastos, o progresso em relação às metas de dívida e investimento, e o status da reserva de emergência.
                `;

                const analysis = await geminiApiCall(prompt);
                
                if (analysis) {
                    analysisContent.innerHTML = analysis;
                } else {
                    analysisContent.innerHTML = '<p class="text-red-500 text-center">Ocorreu um erro ao gerar a análise. Por favor, tente novamente mais tarde.</p>';
                }
            }
            
            const loadInitialData = async () => {
                const initialDebts = [
                    { id: 3, name: "Empréstimo Daycoval 1", total: 11258 },
                    { id: 4, name: "Empréstimo Santander 1", total: 5518 },
                    { id: 5, name: "Empréstimo Santander 2", total: 2429 },
                    { id: 6, name: "Empréstimo Santander 3", total: 3299 },
                    { id: 7, name: "Empréstimo Sicoob 1", total: 6052 },
                    { id: 8, name: "Empréstimo Sicoob 2", total: 18846 },
                    { id: 9, name: "Empréstimo Daycoval 2", total: 10000 }
                ];
                
                const initialCreditCards = [
                    { id: 1, name: "Cartão de Crédito Olé", limit: 3229 },
                    { id: 2, name: "Cartão de Crédito Credcesta", limit: 13183 }
                ];

                const augustTransactions = [
                    { description: 'Salário', amount: 3600, type: 'revenue' },
                    { description: 'Delegada', amount: 888, type: 'revenue' },
                    { description: 'Aluguel', amount: 750, type: 'expense' },
                    { description: 'Energia', amount: 150, type: 'expense' },
                    { description: 'Água', amount: 80, type: 'expense' },
                    { description: 'Internet', amount: 100, type: 'expense' },
                    { description: 'Telefone', amount: 50, type: 'expense' },
                    { description: 'Supermercado', amount: 1200, type: 'expense' },
                    { description: 'Transporte', amount: 200, type: 'expense' },
                    { description: 'Saúde', amount: 300, type: 'expense' },
                    { description: 'Lazer', amount: 400, type: 'expense' },
                    { description: 'Investimentos', amount: 200, type: 'investment' },
                    { description: 'Reserva de Emergência', amount: 100, type: 'emergency' },
                    { description: 'Pagamento Fatura Olé', amount: 188, type: 'debt', debtId: 1 }, 
                    { description: 'Pagamento Fatura Credcesta', amount: 748, type: 'debt', debtId: 2 },
                    { description: 'Pagamento Daycoval 1', amount: 337, type: 'debt', debtId: 3 },
                    { description: 'Pagamento Santander 1', amount: 140, type: 'debt', debtId: 4 },
                    { description: 'Pagamento Santander 2', amount: 77, type: 'debt', debtId: 5 },
                    { description: 'Pagamento Santander 3', amount: 138.72, type: 'debt', debtId: 6 },
                    { description: 'Pagamento Sicoob 1', amount: 238, type: 'debt', debtId: 7 },
                    { description: 'Pagamento Sicoob 2', amount: 721, type: 'debt', debtId: 8 },
                    { description: 'Pagamento Daycoval 2', amount: 337, type: 'debt', debtId: 9 }
                ].map((item, index) => ({ id: new Date(2025, 7, 1).getTime() + index, ...item }));
                
                const initialData = {
                    transactions: augustTransactions,
                    debts: initialDebts,
                    creditCards: initialCreditCards,
                    settings: {
                        investmentGoal: 0
                    }
                };

                await setDoc(userDocRef, initialData);
            };

            const updateApp = () => {
                renderCategorizedTransactions();
                renderImportedTransactions();
                updateSummary();
                if(!dashboardView.classList.contains('hidden')) {
                    updateDashboard();
                }
            };

            const openModal = (modalEl) => {
                modalEl.classList.remove('opacity-0', 'pointer-events-none');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            };
            const closeModal = (modalEl) => {
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modalEl.classList.add('pointer-events-none'), 300);
            };

            const renderDebtDetails = () => {
                debtDetailsList.innerHTML = '';
                if (debts.length === 0) {
                    debtDetailsList.innerHTML = '<p class="text-center text-gray-500">Nenhuma dívida cadastrada.</p>';
                    return;
                }
                debts.forEach(debt => {
                    const paidAmount = transactions.filter(t => t.type === 'debt' && t.debtId === debt.id).reduce((acc, t) => acc + t.amount, 0);
                    const remaining = debt.total - paidAmount;
                    const progress = debt.total > 0 ? (paidAmount / debt.total) * 100 : 0;
                    
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 p-4 rounded-lg';
                    el.innerHTML = `<div class="flex justify-between items-start"><p class="font-bold">${debt.name}</p><div class="flex gap-2"><button onclick="openDebtFormModal(${debt.id})" class="text-gray-400 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg></button><button onclick="confirmDelete('debt', ${debt.id})" class="text-gray-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div><div class="w-full bg-gray-200 rounded-full h-2.5 my-2"><div class="bg-orange-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div><div class="flex justify-between text-sm"><span>Pago: <strong class="text-green-600">${formatCurrency(paidAmount)}</strong></span><span>Falta: <strong class="text-red-600">${formatCurrency(remaining)}</strong></span><span>Total: <strong>${formatCurrency(debt.total)}</strong></span></div>`;
                    debtDetailsList.appendChild(el);
                });
            };

            const renderCreditCardDetails = () => {
                creditCardDetailsList.innerHTML = '';
                if (creditCards.length === 0) {
                    creditCardDetailsList.innerHTML = '<p class="text-center text-gray-500">Nenhum cartão cadastrado.</p>';
                    return;
                }
                creditCards.forEach(card => {
                    const spentAmount = transactions.filter(t => t.type === 'creditCard' && t.creditCardId === card.id).reduce((acc, t) => acc + t.amount, 0);
                    const remainingLimit = card.limit - spentAmount;
                    const progress = card.limit > 0 ? (spentAmount / card.limit) * 100 : 0;
                    
                    const el = document.createElement('div');
                    el.className = 'bg-gray-50 p-4 rounded-lg';
                    el.innerHTML = `<div class="flex justify-between items-start"><p class="font-bold">${card.name}</p><div class="flex gap-2"><button onclick="openCreditCardFormModal(${card.id})" class="text-gray-400 hover:text-blue-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg></button><button onclick="confirmDelete('creditCard', ${card.id})" class="text-gray-400 hover:text-red-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div></div><div class="w-full bg-gray-200 rounded-full h-2.5 my-2"><div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div><div class="flex justify-between text-sm"><span>Fatura: <strong class="text-red-600">${formatCurrency(spentAmount)}</strong></span><span>Disponível: <strong class="text-green-600">${formatCurrency(remainingLimit)}</strong></span><span>Limite: <strong>${formatCurrency(card.limit)}</strong></span></div>`;
                    creditCardDetailsList.appendChild(el);
                });
            };

            window.openDebtFormModal = (id = null) => {
                const form = document.getElementById('debt-form');
                form.reset();
                if (id) {
                    const debt = debts.find(d => d.id === id);
                    if (!debt) return;
                    document.getElementById('debt-form-title').textContent = 'Editar Dívida';
                    document.getElementById('debt-id').value = debt.id;
                    document.getElementById('debt-name').value = debt.name;
                    document.getElementById('debt-total').value = debt.total;
                } else {
                    document.getElementById('debt-form-title').textContent = 'Nova Dívida';
                    document.getElementById('debt-id').value = '';
                }
                openModal(modals.debtForm);
            };

             window.openCreditCardFormModal = (id = null) => {
                const form = document.getElementById('credit-card-form');
                form.reset();
                if (id) {
                    const card = creditCards.find(c => c.id === id);
                    if (!card) return;
                    document.getElementById('credit-card-form-title').textContent = 'Editar Cartão';
                    document.getElementById('credit-card-id').value = card.id;
                    document.getElementById('credit-card-name').value = card.name;
                    document.getElementById('credit-card-limit').value = card.limit;
                } else {
                    document.getElementById('credit-card-form-title').textContent = 'Novo Cartão';
                    document.getElementById('credit-card-id').value = '';
                }
                openModal(modals.creditCardForm);
            };

            const saveDebt = async (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('debt-id').value);
                const name = document.getElementById('debt-name').value;
                const total = parseFloat(document.getElementById('debt-total').value);
                if (!name || isNaN(total)) return;
                
                let newDebts = [...debts];
                if (id) {
                    const index = newDebts.findIndex(d => d.id === id);
                    if (index > -1) newDebts[index] = { ...newDebts[index], name, total };
                } else {
                    const newId = newDebts.length > 0 ? Math.max(...newDebts.map(d => d.id)) + 1 : 1;
                    newDebts.push({ id: newId, name, total });
                }
                await updateDoc(userDocRef, { debts: newDebts });
                closeModal(modals.debtForm);
            };

            const saveCreditCard = async (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('credit-card-id').value);
                const name = document.getElementById('credit-card-name').value;
                const limit = parseFloat(document.getElementById('credit-card-limit').value);
                if (!name || isNaN(limit)) return;
                
                let newCreditCards = [...creditCards];
                if (id) {
                    const index = newCreditCards.findIndex(c => c.id === id);
                    if (index > -1) newCreditCards[index] = { ...newCreditCards[index], name, limit };
                } else {
                    const newId = newCreditCards.length > 0 ? Math.max(...newCreditCards.map(c => c.id)) + 1 : 1;
                    newCreditCards.push({ id: newId, name, limit });
                }
                await updateDoc(userDocRef, { creditCards: newCreditCards });
                closeModal(modals.creditCardForm);
            };

            window.confirmDelete = (type, id) => {
                itemToDelete = { type, id };
                const item = type === 'debt' ? debts.find(d => d.id === id) : creditCards.find(c => c.id === id);
                document.getElementById('confirm-modal-text').textContent = `Tem certeza que deseja excluir "${item.name}" e todas as transações associadas?`;
                openModal(modals.confirm);
            };

            const executeDelete = async () => {
                let newDebts = [...debts];
                let newCreditCards = [...creditCards];
                let newTransactions = [...transactions];

                if (itemToDelete.type === 'debt') {
                    newDebts = debts.filter(d => d.id !== itemToDelete.id);
                    newTransactions = transactions.filter(t => t.debtId !== itemToDelete.id);
                    await updateDoc(userDocRef, { debts: newDebts, transactions: newTransactions });
                } else if (itemToDelete.type === 'creditCard') {
                    newCreditCards = creditCards.filter(c => c.id !== itemToDelete.id);
                    newTransactions = transactions.filter(t => t.creditCardId !== itemToDelete.id);
                    await updateDoc(userDocRef, { creditCards: newCreditCards, transactions: newTransactions });
                }
                closeModal(modals.confirm);
            };

            // Event Listeners
            document.getElementById('add-transaction-btn').addEventListener('click', () => openModal(modals.transaction));
            document.getElementById('import-btn').addEventListener('click', () => openModal(modals.import));
            document.getElementById('edit-investment-goal-btn').addEventListener('click', () => { document.getElementById('investment-goal-amount').value = investmentGoal > 0 ? investmentGoal : ''; openModal(modals.investmentGoal); });
            document.getElementById('debt-summary-card').addEventListener('click', () => { renderDebtDetails(); openModal(modals.debtDetails); });
            document.getElementById('credit-card-summary-card').addEventListener('click', () => { renderCreditCardDetails(); openModal(modals.creditCardDetails); });
            document.getElementById('add-debt-btn').addEventListener('click', () => openDebtFormModal());
            document.getElementById('add-credit-card-btn').addEventListener('click', () => openCreditCardFormModal());
            document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);
            document.getElementById('analyze-btn').addEventListener('click', getFinancialAnalysis);

            transactionsViewBtn.addEventListener('click', () => {
                dashboardView.classList.add('hidden'); transactionsView.classList.remove('hidden');
                transactionsViewBtn.classList.add('active'); dashboardViewBtn.classList.remove('active');
            });
            dashboardViewBtn.addEventListener('click', () => {
                transactionsView.classList.add('hidden'); dashboardView.classList.remove('hidden');
                dashboardViewBtn.classList.add('active'); transactionsViewBtn.classList.remove('active');
                updateDashboard();
            });

            Object.values(modals).forEach(modalEl => {
                modalEl.addEventListener('click', (e) => e.target === modalEl && closeModal(modalEl));
                modalEl.querySelector('button[id^="close-"]')?.addEventListener('click', () => closeModal(modalEl));
            });
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal(modals.confirm));
            
            document.getElementById('transaction-form').addEventListener('submit', addTransaction);
            document.getElementById('import-form').addEventListener('submit', handleImport);
            document.getElementById('investment-goal-form').addEventListener('submit', (e) => setInvestmentGoal(e));
            document.getElementById('debt-form').addEventListener('submit', saveDebt);
            document.getElementById('credit-card-form').addEventListener('submit', saveCreditCard);
            document.querySelectorAll('.categorize-btn').forEach(btn => btn.addEventListener('click', () => categorizeTransaction(btn.dataset.type)));

            document.querySelectorAll('input[name="type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    debtSelectorContainer.classList.toggle('hidden', e.target.value !== 'debt');
                    creditCardSelectorContainer.classList.toggle('hidden', e.target.value !== 'creditCard');
                });
            });

            const populateDebtSelector = () => {
                debtSelector.innerHTML = '';
                debts.forEach(debt => {
                    const option = document.createElement('option');
                    option.value = debt.id;
                    option.textContent = debt.name;
                    debtSelector.appendChild(option);
                });
            };

            const populateCreditCardSelector = () => {
                creditCardSelector.innerHTML = '';
                creditCards.forEach(card => {
                    const option = document.createElement('option');
                    option.value = card.id;
                    option.textContent = card.name;
                    creditCardSelector.appendChild(option);
                });
            };

            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') Object.values(modals).forEach(closeModal); });
            
            // --- Inicialização do App com Firebase ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    userId = user.uid;
                    userDocRef = doc(db, "artifacts", appId, "users", userId);

                    if (unsubscribe) unsubscribe(); // Cancela o listener anterior se houver

                    unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            transactions = data.transactions || [];
                            debts = data.debts || [];
                            creditCards = data.creditCards || [];
                            investmentGoal = data.settings?.investmentGoal || 0;
                            
                            populateDebtSelector();
                            populateCreditCardSelector();
                            updateApp();
                        } else {
                            console.log("Nenhum documento encontrado! Criando dados iniciais.");
                            loadInitialData();
                        }
                    });
                }
            });

            // Autenticação
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        });
    </script>
    <!-- Script para registrar o Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
              console.log('Service Worker registrado com sucesso:', registration);
            })
            .catch(error => {
              console.log('Falha ao registrar o Service Worker:', error);
            });
        });
      }
    </script>
</body>
</html>
